# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# MailVoyage â€” Auto-Versioned Build & Push to Docker Hub
#
# Versioning: CalVer â€” YYYY.M.BUILD (e.g. 2026.2.1, 2026.2.2)
#   â€¢ Build number auto-increments per month from existing git tags
#   â€¢ Every push to main gets a unique version â€” zero manual work
#
# Triggers:
#   â€¢ Push to main branch (auto-version + build + push)
#   â€¢ Manual via workflow_dispatch (optional tag override)
#
# Required GitHub Secrets:
#   DOCKERHUB_USERNAME  â€” your Docker Hub username
#   DOCKERHUB_TOKEN     â€” Docker Hub access token (NOT password)
#
# Automatically provided (no setup needed):
#   GITHUB_TOKEN        â€” used to create git tags & releases
#
# Docker Hub repo: navaranjithsai/mailvoyage
# GitHub repo:     navaranjithsai/MailVoyage
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

name: Build & Push Docker Image

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'LICENSE'
      - '.github/ISSUE_TEMPLATE/**'
  workflow_dispatch:
    inputs:
      tag_override:
        description: 'Custom version tag (e.g. 2026.2.99-beta). Leave empty for auto CalVer.'
        required: false
        type: string

# Cancel in-flight runs for the same branch
concurrency:
  group: docker-${{ github.ref }}
  cancel-in-progress: true

env:
  DOCKER_IMAGE: navaranjithsai/mailvoyage

jobs:
  version:
    name: Calculate Version
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      version: ${{ steps.calver.outputs.version }}
      version_tag: ${{ steps.calver.outputs.version_tag }}
    steps:
      - name: Checkout (with tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for tag discovery

      - name: Calculate CalVer version
        id: calver
        run: |
          YEAR=$(date -u +%Y)
          MONTH=$(date -u +%-m)  # No zero-padding: 1-12
          PREFIX="v${YEAR}.${MONTH}"

          # If manual override provided, use it directly
          if [[ -n "${{ inputs.tag_override }}" ]]; then
            VERSION="${{ inputs.tag_override }}"
            echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
            echo "version_tag=v${VERSION}" >> "$GITHUB_OUTPUT"
            echo "## Version (manual override)" >> "$GITHUB_STEP_SUMMARY"
            echo "**${VERSION}**" >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          # Find the highest existing build number for this year.month
          LATEST_BUILD=$(git tag --list "${PREFIX}.*" --sort=-version:refname | head -n1 | grep -oP '\d+$' || echo "0")
          NEXT_BUILD=$((LATEST_BUILD + 1))
          VERSION="${YEAR}.${MONTH}.${NEXT_BUILD}"

          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "version_tag=v${VERSION}" >> "$GITHUB_OUTPUT"

          echo "## Version Calculated" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Previous:** ${PREFIX}.${LATEST_BUILD}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Next:** v${VERSION}" >> "$GITHUB_STEP_SUMMARY"

  build-and-push:
    name: Build & Push
    needs: version
    runs-on: ubuntu-latest
    permissions:
      contents: write   # Create tags + releases
      packages: write

    steps:
      # â”€â”€ Checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # â”€â”€ Update package.json versions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Sync version in package.json files
        run: |
          VERSION="${{ needs.version.outputs.version }}"
          echo "Setting version to ${VERSION} in package.json files..."

          # Update root package.json
          jq --arg v "$VERSION" '.version = $v' package.json > tmp.json && mv tmp.json package.json

          # Update api/package.json
          jq --arg v "$VERSION" '.version = $v' api/package.json > tmp.json && mv tmp.json api/package.json

          echo "### package.json versions updated to ${VERSION}" >> "$GITHUB_STEP_SUMMARY"

      # â”€â”€ Create git tag â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Create version tag
        run: |
          VERSION_TAG="${{ needs.version.outputs.version_tag }}"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Commit the version bump (if changed)
          if git diff --quiet; then
            echo "No version file changes to commit"
          else
            git add package.json api/package.json
            git commit -m "chore: bump version to ${VERSION_TAG} [skip ci]"
            git push origin main
          fi

          # Create annotated tag
          git tag -a "${VERSION_TAG}" -m "Release ${VERSION_TAG}"
          git push origin "${VERSION_TAG}"

          echo "### Git tag created: ${VERSION_TAG}" >> "$GITHUB_STEP_SUMMARY"

      # â”€â”€ Docker metadata (tags + labels) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_IMAGE }}
          tags: |
            type=raw,value=latest
            type=raw,value=${{ needs.version.outputs.version }}
            type=sha,prefix=sha-
          labels: |
            org.opencontainers.image.title=MailVoyage
            org.opencontainers.image.description=Modern, privacy-focused open-source email client
            org.opencontainers.image.version=${{ needs.version.outputs.version }}
            org.opencontainers.image.source=https://github.com/navaranjithsai/MailVoyage
            org.opencontainers.image.licenses=AGPL-3.0
            org.opencontainers.image.vendor=navaranjithsai

      # â”€â”€ Set up Docker Buildx (multi-platform support) â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # â”€â”€ Login to Docker Hub â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # â”€â”€ Build and push â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: true
          sbom: true

      # â”€â”€ GitHub Release â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.version.outputs.version_tag }}
          name: MailVoyage ${{ needs.version.outputs.version_tag }}
          generate_release_notes: true
          body: |
            ## Docker Image

            ```bash
            docker pull navaranjithsai/mailvoyage:${{ needs.version.outputs.version }}
            ```

            **Tags published:**
            - `navaranjithsai/mailvoyage:${{ needs.version.outputs.version }}`
            - `navaranjithsai/mailvoyage:latest`
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # â”€â”€ Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build summary
        run: |
          echo "## ðŸ³ Docker Image Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ needs.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Docker tags:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`navaranjithsai/mailvoyage:${{ needs.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`navaranjithsai/mailvoyage:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pull:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull navaranjithsai/mailvoyage:${{ needs.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
